<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>我的</title>
<style>
body { margin: 0; background: #f5f5f5; font-family: Arial; }
.header { padding: 20px; background: white; font-size: 22px; font-weight: bold; border-bottom: 1px solid #eee; }
.profile-card { margin: 15px; padding: 20px; background: white; border-radius: 10px; display: flex; align-items: center; gap: 15px; }
.avatar { width: 70px; height: 70px; background: #ddd; border-radius: 50%; }
.profile-info p { margin: 5px 0; }
.module { margin: 15px; padding: 15px; background: white; border-radius: 10px; font-size: 16px; }
.module h3 { margin-top: 0; }
.product-list { display: flex; gap: 10px; flex-wrap: wrap; }
.product-card { width: 48%; background: #fff; border-radius: 10px; overflow: hidden; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.product-card img {
    width: 100%;
    height: 120px;        /* 固定高度 */
    object-fit: cover;    /* 保持比例裁剪填充 */
    display: block;
    border-bottom: 1px solid #eee;
}
.product-card .title { padding: 8px; font-size: 14px; text-align: center; }
.logout-btn { width: 90%; margin: 20px auto; display: block; padding: 12px; font-size: 18px; background: #ff4d4f; color: white; border: none; border-radius: 8px; cursor: pointer; text-align: center; }
.bottom-nav { position: fixed; bottom: 0; width: 100%; height: 55px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; }
.nav-item { text-align: center; font-size: 14px; color: #444; text-decoration: none; }
</style>
</head>
<body>

<div class="header">我的</div>

<div class="profile-card">
    <div class="avatar"></div>
    <div class="profile-info">
        <p id="nickname">昵称：未加载</p>
        <p id="username">账号：未加载</p>
        <p id="email">邮箱：未加载</p>
    </div>
</div>

<div class="module">
    <h3>我的发布</h3>
    <div class="product-list" id="my-products">
        <p>加载中...</p>
    </div>
</div>

<button class="logout-btn" onclick="logout()">退出登录</button>

<div class="bottom-nav">
    <a class="nav-item" href="/index.html">首页</a>
    <a class="nav-item" href="/publish.html">发布</a>
    <a class="nav-item" href="/messages.html">消息</a>
    <a class="nav-item" href="/mine.html">我的</a>
</div>

<script>
window.onload = async function() {
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.username || !user.id) {
        alert("请先登录");
        window.location.href = "/login.html";
        return;
    }
    document.getElementById("nickname").innerText = "昵称：" + (user.name || "未设置");
    document.getElementById("username").innerText = "账号：" + (user.username || "未知");
    document.getElementById("email").innerText = "邮箱：" + (user.email || "未知");

    // 调用后端接口获取当前用户商品
    const res = await fetch(`/products/show/${user.id}`);
    const products = await res.json();

    const container = document.getElementById("my-products");
    container.innerHTML = "";

    if (!products || products.length === 0) {
        container.innerHTML = "<p>暂无发布商品</p>";
        return;
    }

    // 只显示最近两条
    const recentTwo = products.slice(-2).reverse();

    recentTwo.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";

        const imgSrc = (p.images && p.images.length > 0) ? p.images[0] : "/images/default.jpg";

        card.innerHTML = `
            <img src="${imgSrc}">
            <div class="title">${p.title}</div>
        `;

        card.onclick = () => {
            window.location.href = `/product_detail.html?id=${p.id}`;
        };

        container.appendChild(card);
    });
};

function logout() {
    localStorage.removeItem("user");
    alert("已退出登录");
    window.location.href = "/login.html";
}
</script>

</body>
</html>
